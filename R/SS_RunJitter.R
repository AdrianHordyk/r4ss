#' Iteratively apply the jitter option in SS
#'
#' Iteratively run a Stock Synthesis model with different jittered starting
#' parameter values based on the jitter fraction. Output files are renamed
#' in the format Report1.sso, Report2.sso, etc.
#'
#' @param mydir Directory where model files are located.
#' @param model Executable name of the \code{.exe} file in \code{mydir}
#'  without the extension, e.g., \code{"ss"}.
#' @param extras Additional command line arguments passed to the executable.
#'   The default, \code{"-nohess"}, runs each jittered model without the hessian.
#' @param Njitter Number of jitters, or a vector of jitter iterations.
#'   If \code{length(Njitter) > 1} only the iterations specified will be ran,
#'   else \code{1:Njitter} will be executed.
#' @param Intern Show command line info in R console or keep hidden. The default,
#'   \code{TRUE}, keeps the executable hidden.
#' @param systemcmd Option to switch between 'shell' and 'system'. The default,
#'   \code{FALSE}, facilitates using the shell command on Windows.
#' @param printlikes A logical value specifying if the likelihood values should
#'   be printed to the console.
#' @template verbose
#' @param jitter_fraction The value, typically 0.1, used to define a uniform
#'   distribution in cumulative normal space to generate new initial parameter values.
#'   The default of \code{NULL} forces the user to specify the jitter_fraction
#'   in the starter file, and this value must be greater than zero and
#'   will not be overwritten.
#' @param init_values_src Either zero or one, specifying if the initial values to
#'   jitter should be read from the control file or from the par file, respectively.
#'   The default is \code{NULL}, which will leave the starter file unchanged.
#' @author James T. Thorson, Kelli F. Johnson, Ian G. Taylor
#' @return A vector of likelihoods for each jitter iteration.
#' @export
#' @examples
#' \dontrun{
#'   #### Run jitter from par file with arbitrary, but common, choice of 0.1
#'   modeldir <- tail(dir(system.file("extdata", package="r4ss"), full.names=TRUE),1)
#'   numjitter <- 25
#'   jit.likes <- SS_RunJitter(mydir=modeldir, Njitter=numjitter,
#'    jitter_fraction=0.1, init_value_src=1)
#'
#'   #### Read in results using other r4ss functions
#'   # (note that un-jittered model can be read using keyvec=0:numjitter)
#'   profilemodels <- SSgetoutput(dirvec=modeldir, keyvec=1:numjitter, getcovar=FALSE)
#'   # summarize output
#'   profilesummary <- SSsummarize(profilemodels)
#'   # Likelihoods
#'   profilesummary$likelihoods[1,]
#'   # Parameters
#'   profilesummary$pars
#' }

SS_RunJitter <- function(mydir,
                         model = "ss",
                         extras = "-nohess",
                         Njitter,
                         Intern = TRUE,
                         systemcmd = FALSE,
                         printlikes = TRUE,
                         verbose = FALSE,
                         jitter_fraction = NULL,
                         init_values_src = NULL) {
  # Determine working directory on start and return upon exit
  startdir <- getwd()
  on.exit(setwd(startdir))
  setwd(mydir)
  }

  if (verbose) {
    message("Temporarily changing working directory to:\n", mydir)
    if (!file.exists("Report.sso")) {
      message("Copy output files from a converged run into\n",
        mydir, "\nprior to running SS_RunJitter to enable easier comparisons.")
    }
    message("Checking starter file")
  }
  # read starter file to test for non-zero jitter value
  starter <- SS_readstarter(verbose=verbose)
  if (starter$jitter_fraction == 0 & is.null(jitter_fraction)) {
    stop("Change the jitter value in the starter file to be > 0\n",
      "or change the jitter_fraction argument to be > 0.", call. = FALSE)
  }
  if (!is.null(jitter_fraction)) {
    starter$jitter_fraction <- jitter_fraction
  }
  if (!is.null(init_values_src)) {
    starter$init_values_src <- init_values_src
  }
  r4ss::SS_writestarter(starter, overwrite = TRUE, verbose = FALSE, warn = FALSE)

  message("Renaming output files to have names like Report0.sso") 
  file.rename(from="CompReport.sso", to="CompReport0.sso")
  file.rename(from="covar.sso", to="covar0.sso")
  file.rename(from="Report.sso", to="Report0.sso")
  file.rename(from="ParmTrace.sso", to="ParmTrace0.sso")
  file.rename(from="warning.sso", to="warning0.sso")
  file.rename(from=paste0(model,".par"), to=paste0(model,".par_0.sso"))

  # create empty ss.dat file to avoid the ADMB message
  # "Error trying to open data input file ss.dat"
  file.create(paste0(model,".dat"))

  # check length of Njitter input
  if (length(Njitter) == 1){
    Njitter <- 1:Njitter
  }
  likesaved <- rep(NA, length(Njitter))
  for(i in Njitter){
    if (verbose) message("Jitter=", i, ", ", date())
    # check for use of .par file and replace original if needed
    if(starter$init_values_src == 1){
      if (verbose) message("Replacing .par file with original")
      file.copy(from=paste0(model,".par_0.sso"), to=paste0(model,".par"), overwrite=TRUE)
    }
    # run model
    command <- paste(model, extras)
    if (.Platform$OS.type!="windows") {
      command <- paste0("./", command)
    }

    if (i == 1 & verbose){
      message("Running SS jitter in directory: ", getwd(),
        "\nUsing the command: ", command)
    }
    if (.Platform$OS.type == "windows" & !systemcmd) {
      shell(cmd = command, intern = Intern)
    }else{
      system(command, intern = Intern, show.output.on.console = !Intern)
    }
    # Only save stuff if it converged
    if ("Report.sso" %in% list.files()) {
        Rep.head <- readLines("Report.sso", n = 300)
        likelinenum <- grep("^LIKELIHOOD", Rep.head)
        if(length(likelinenum)==0){
          warning("can't find LIKELIHOOD section in Report.sso")
          like <- NA
        }else{
          likeline <- Rep.head[likelinenum]
          like <- as.numeric(substring(likeline, nchar("LIKELIHOOD") + 2))
          likesaved[i] <- like
        }
      if (printlikes){
        message("Likelihood for jitter ", i, " = ", like)
      }
      # rename output files
      file.rename(from="CompReport.sso", to=paste0("CompReport",i,".sso"))
      file.rename(from="covar.sso", to=paste0("covar",i,".sso"))
      file.rename(from="Report.sso", to=paste0("Report",i,".sso"))
      file.rename(from="ParmTrace.sso", to=paste0("ParmTrace",i,".sso"))
      file.rename(from="warning.sso", to=paste0("warning",i,".sso"))
      file.rename(from=paste0(model,".par"), to=paste0(model,".par_",i,".sso"))
    } else{
      warning("No Report.sso file found from run ", i)
    }
  }
  # Move original files back
  file.copy(from="CompReport0.sso", to="CompReport.sso", overwrite=TRUE)
  file.copy(from="covar0.sso", to="covar.sso", overwrite=TRUE)
  file.copy(from="Report0.sso", to="Report.sso", overwrite=TRUE)
  file.copy(from="ParmTrace0.sso", to="ParmTrace.sso", overwrite=TRUE)
  file.copy(from="warning0.sso", to="warning.sso", overwrite=TRUE)
  file.copy(from=paste(model,".par_0.sso",sep=""), to=paste(model,".par",sep=""),
            overwrite=TRUE)

  if (printlikes){
    message("Table of likelihood values:")
    print(table(likesaved))
  }
  return(invisible(likesaved))
}
